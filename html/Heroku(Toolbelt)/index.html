<html><head><title>Heroku and API Integration (Toolbelt)</title><style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw');ol{margin:0;padding:0}.c33{list-style-type:circle;margin:0;padding:0}.c12{list-style-type:decimal;margin:0;padding:0}.c7{color:#1155cc;text-decoration:underline}.c11{color:inherit;text-decoration:inherit}.c0{text-align:center;direction:ltr}.c6{color:#1155cc;background-color:#ffffff}.c1{direction:ltr;margin-left:36pt}.c26{margin:5px;border:1px solid black}.c31{max-width:468pt;padding:72pt 72pt 72pt 72pt}.c2{text-indent:36pt;height:11pt}.c9{font-size:9pt;font-family:"Courier New"}.c24{color:#333333;font-family:"Consolas"}.c28{color:#1155cc}.c20{text-align:right}.c13{margin-left:54pt}.c3{direction:ltr}.c8{height:11pt}.c5{font-weight:bold}.c15{height:18pt}.c29{color:#666666}.c18{line-height:1.0}.c22{margin-left:18pt}.c25{background-color:#ffffff}.c14{font-style:italic}.c32{margin-left:396pt}.c19{background-color:#ffff00}.c10{text-indent:36pt}.c17{margin-left:72pt}.c34{font-size:14pt}.c16{font-family:"Courier New"}.c30{background-color:#f8f8f8}.c21{font-size:10pt}.c23{height:14pt}.c27{font-size:12pt}.c4{padding-left:0pt}.title{padding-top:24pt;line-height:1.15;text-align:left;color:#000000;font-size:36pt;font-family:"Arial";font-weight:bold;padding-bottom:6pt}.subtitle{padding-top:18pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:24pt;font-family:"Georgia";padding-bottom:4pt}li{color:#000000;font-size:11pt;font-family:"Arial"}p{color:#000000;font-size:11pt;margin:0;font-family:"Arial"}h1{padding-top:24pt;line-height:1.15;text-align:left;color:#000000;font-size:18pt;font-family:"Arial";font-weight:bold;padding-bottom:6pt}h2{padding-top:18pt;line-height:1.15;text-align:left;color:#000000;font-size:14pt;font-family:"Arial";font-weight:bold;padding-bottom:4pt}h3{padding-top:14pt;line-height:1.15;text-align:left;color:#666666;font-size:12pt;font-family:"Arial";font-weight:bold;padding-bottom:4pt}h4{padding-top:12pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Arial";padding-bottom:2pt}h5{padding-top:11pt;line-height:1.15;text-align:left;color:#666666;font-size:10pt;font-family:"Arial";font-weight:bold;padding-bottom:2pt}h6{padding-top:10pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:10pt;font-family:"Arial";padding-bottom:2pt}
.toc p { font-size: 12px; width 240px; }
.toc a { text-decoration: none; }
.toc span { text-decoration: none; }
body {background-color: white;}</style>
</head>


<body class="c22">
<div class="toc" style="position:fixed; top: 2px; left: -20px; width: 300px; background-color: white; border: 1px solid black; padding: 5px; font-size: 9px;">
<p class="c3 c22"><span class="c7"><a class="c11" href="#h.1n5u8tsc3kvw">Prerequisites</a></span></p><p class="c13 c3"><span class="c7"><a class="c11" href="#h.d8tyzqip5rp7">Force.com</a></span></p><p class="c3 c13"><span class="c7"><a class="c11" href="#h.mvqwuwhu6tt4">Heroku</a></span></p><p class="c13 c3"><span class="c7"><a class="c11" href="#h.gmrvyg1wm2b0">Heroku Toolbelt</a></span></p><p class="c13 c3"><span class="c7"><a class="c11" href="#h.5w69y8hfsjsw">Data Model</a></span></p><p class="c3 c22"><span class="c7"><a class="c11" href="#h.n3ikcvdmyeq3">Integrating Force.com with External Systems</a></span></p><p class="c3 c22"><span class="c7"><a class="c11" href="#h.npj66reh1ecd">Part I: Create a Heroku Application</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.uy2mwldzo2eg">Step 1: Clone the Github Project</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.4vd7tsxuama8">Step 2: Create a Heroku Project</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.d909d02t06ve">Step 3: Test the Application</a></span></p><p class="c3 c22"><span class="c7"><a class="c11" href="#h.w59gn0ujoma2">Part II: Create an Apex Trigger for Integration</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.fgax833a1ph">Step 1: Create an External ID Field on Invoice Statement</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.217nub6esq17">Step 2: Create a Remote Site Record</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.nfc20t8ry5j4">Step 3: Create an Integration Apex Class</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.ovy1gmh3ohxe">Step 4: Test the @future Method</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.4obqf43q41z2">Step 5: Create a Trigger to Call the @future Method</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.we1pdt4ibhiq">Step 6: Test the Integration</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.fv6gbohj21dj">Summary</a></span></p><p class="c3 c22"><span class="c7"><a class="c11" href="#h.5l9vqdmv432v">Part III: Update the Heroku App</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.to17tripf0ho">Step 1: Configure Remote Access</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.e7e752yuymeb">Step 2: Update your application with a new branch</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.l4zeiy2u1zps">Step 3: Update the User Interface with Invoice Information</a></span></p><p class="c1"><span class="c7"><a class="c11" href="#h.6sk8zyazmu6h">Summary</a></span></p>
	</div>
	
	<div style="position: absolute; left: 350px; width: 800px;">		
	<h1 style="font-size: 32px">Heroku and API Integration</h1>
	<p class="c3 c8"><span class="c19"></span></p><h1 class="c3"><a name="h.1n5u8tsc3kvw"></a><a href="#" name="id.9qri54jrpngi"></a><span>Prerequisites</span></h1><h3 class="c3"><a name="h.d8tyzqip5rp7"></a><span>Force.com</span></h3><p class="c3"><span class="c7"><a class="c11" href="http://www.developerforce.com/events/regular/registration.php">Sign up </a></span><span>for a free Force.com Developer Edition (DE) organization (org):</span></p><p class="c3"><span class="c28"><a class="c11" href="http://www.developerforce.com/events/regular/registration.php">http://www.developerforce.com/events/regular/registration.php</a></span></p><h3 class="c3"><a name="h.mvqwuwhu6tt4"></a><span>Heroku</span></h3><p class="c3"><span class="c7"><a class="c11" href="https://api.heroku.com/signup">Sign up </a></span><span>for a free Heroku account:</span></p><p class="c3"><span class="c28 c21"><a class="c11" href="https://api.heroku.com/signup">https://api.heroku.com/signup</a></span><span class="c21 c29">&nbsp;</span></p><h3 class="c3"><a name="h.gmrvyg1wm2b0"></a><span>Heroku Toolbelt</span></h3><p class="c3"><span>Download and install the Heroku Toolbelt:</span></p><p class="c3"><span class="c28"><a class="c11" href="https://toolbelt.heroku.com/">https://toolbelt.heroku.com/</a></span></p><h3 class="c3"><a name="h.5w69y8hfsjsw"></a><span>Data Model</span></h3><p class="c3"><span>This tutorial assumes you have created the Warehouse data model. &nbsp;If you have not, you can install it from this link:</span></p><p class="c3"><span class="c6"><a class="c11" href="https://login.salesforce.com/packaging/installPackage.apexp?p0=04tE0000000Pzdj">https://login.salesforce.com/packaging/installPackage.apexp?p0=04tE0000000Pzdj</a></span></p><p class="c3 c8"><span></span></p><h1 class="c0 c15"><a name="h.paqj8yst08ef"></a></h1><h1 class="c0 c15"><a name="h.7kca9tn9xxtg"></a></h1><h1 class="c3"><a name="h.r0j5o0241ek1"></a><span>Integrating Force.com with External Systems</span></h1><p class="c3"><span>Integrating Force.com with legacy environments is a common use case. Many legacy apps are Java apps, running inside a company&rsquo;s firewall, and still serve useful purposes. The following three tutorials teach you how to first build Java app on Heroku that serves as the integration target.</span></p><p class="c3 c8"><span></span></p><h1 class="c3"><a name="h.qvv1ya8jhbo8"></a><span>Part I: Create a Heroku Application</span></h1><p class="c3"><span>Heroku provides a powerful Platform as a Service for deploying applications in a multitude of languages, including Java. &nbsp;In this tutorial, you create a web application using the Java Spring MVC framework to mimic handling fulfillment requests from our </span><span class="c14">Warehouse</span><span>&nbsp;application.</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>Familiarity with Java is helpful, but not required for this exercise. &nbsp;The tutorial starts with an application template to get you up and running. You then walk through the steps to securely integrate the application with the Force.com platform.</span></p><p class="c3 c8"><span></span></p><h2 class="c3"><a name="h.17a2gqrt0khu"></a><span>Step 1: Clone the Github Project</span></h2><p class="c3"><span>Git is a distributed source control system with an emphasis on speed and ease of use. &nbsp;Heroku integrates directly into git, allowing for continuous deployment of your application by pushing changes into a repository on Heroku. &nbsp;Github is a web-based hosting service for git repositories.</span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p><p class="c3"><span>You&rsquo;ll start with a pre-existing Spring MVC-based application stored on GitHub, and then as you make changes you will deploy them into your Heroku account and see your updates available online via Heroku&rsquo;s cloud framework.</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Open a command line terminal. &nbsp;For OS X users, this can be done by going to the </span><span class="c5">Terminal</span><span>&nbsp;program, under </span><span class="c5">Applications/Utilities</span><span>. &nbsp;For PC users, this can be done by going to the </span><span class="c5">Start Menu</span><span>, and typing </span><span class="c5">cmd</span><span>&nbsp;into the </span><span class="c5">Run</span><span>&nbsp;dialog.</span></li><li class="c1 c4"><span>Once in the command line, change to a directory where you want to download the example app. For example, if your directory is &ldquo;development&rdquo;:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1 c10"><span class="c16">cd development</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="3"><li class="c1 c4"><span>Execute the following command:</span></li></ol><p class="c3 c8"><span></span></p><p class="c3"><span class="c16 c21">git clone </span><span class="c16 c21">https://github.com/developerforce/spring-mvc-fulfillment-base</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>Git then downloads the existing project into a new folder, </span><span class="c14">spring-mvc-fulfillment-base</span><span>.</span></p><p class="c3 c8"><span class="c5"></span></p><h2 class="c3"><a name="h.m1orvqkpwp5t"></a><span>Step 2: Create a Heroku Project</span></h2><p class="c3"><span>Now that you have the project locally, you need a place to deploy it that is accessible on the Web. In this tutorial, you deploy the app to Heroku.</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Change directory to the </span><span class="c14">spring-mvc-fulfillment-base</span><span>&nbsp;folder created in the last step.</span></li></ol><p class="c3 c8"><span></span></p><p class="c3 c17"><span class="c16">cd spring-mvc-fullfillment</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="2"><li class="c1 c4"><span>Execute the following command to login to heroku (followed by Heroku login credentials, if necessary):</span></li></ol><p class="c3 c8"><span></span></p><p class="c1 c10"><span class="c16">heroku login</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="3"><li class="c1 c4"><span>Execute the following command to create a new application on Heroku:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1 c10"><span class="c16">heroku create</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>Heroku then creates a local git repository, as well as a new repository on its hosting framework where you can push applications, and adds the definition for that remote deployment for your local git repository to understand. &nbsp;This makes it easy to leverage git for source control, make local edits and then deploy your application to the Heroku cloud. </span></p><p class="c3 c8"><span></span></p><p class="c3"><span>All application names on Heroku must be unique, so you are going to get a randomly generated application name, such as:</span></p><p class="c3 c8"><span></span></p><p class="c1 c10"><span class="c16">Creating quiet-planet-3215... done</span></p><p class="c3 c8"><span></span></p><h1 class="c3"><a name="h.6gm7tm7bjh51"></a><span>Important Note!</span></h1><p class="c3"><span>The output above shows that the new application name is </span><span class="c5 c19">quiet-planet-3215</span><span>. You may want to copy and paste that into a text file, or otherwise make note of it. Throughout this tutorial, there are references to the application name as </span><span class="c14 c19">{appname}</span><span>. So if your gven application name is </span><span class="c5 c19">quiet-planet-3215</span><span>, when a step prompts you to</span><span class="c5">&nbsp;</span><span>enter a URL with the format </span><span class="c14">https://</span><span class="c14 c19">{appname}</span><span class="c14">.herokuapp.com/_auth</span><span>, you would use:</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>https://</span><span class="c19">quiet-planet-3215</span><span class="c14">.</span><span>herokuapp.com/_auth</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>To deploy the local code to Heroku, execute the following command:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1 c10"><span class="c16">git push heroku master</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>The process will take a while as it moves, grabs any required dependencies, compiles and deploys your application. Once it is complete, you can preview the existing application by executing:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1 c10"><span class="c16">heroku open</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Or by opening https://</span><span class="c14 c19">{appname}</span><span>.herokuapp.com in a browser.</span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p><p class="c3"><span>You now have a new Heroku application in the cloud. The first page should look like this:</span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p><p class="c0"><img height="187" src="images/image04.png" width="383"></p><p class="c0 c8"><span class="c5"></span></p><p class="c3 c8"><span class="c5"></span></p><p class="c3 c8"><span class="c5"></span></p><p class="c3 c8"><span class="c5"></span></p><p class="c3 c8"><span class="c5 c25 c27"></span></p><h3 class="c3"><a name="h.95drpk2ioz4i"></a><span>Tell Me More</span></h3><p class="c3"><span>Look carefully as the git push happens and you&rsquo;ll see some magic. Early on, Heroku detects that the push is a Spring MVC app, so it installs Maven, builds the app, and then gets it running for you, all with just a single command.</span></p><h2 class="c3"><a name="h.d909d02t06ve"></a><span>Step 3: Test the Application</span></h2><p class="c3"><span>This step shows you how to take your application for a quick test run to prove it is functioning.</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>In a browser tab or window, navigate to </span><span class="c16">https://</span><span class="c14 c19 c16">{appname}</span><span class="c16">.herokuapp.com</span><span>.</span></li><li class="c1 c4"><span>Click </span><span class="c5">Ajax @Controller Example</span><span>.</span></li><li class="c1 c4"><span>In another tab or window, open the </span><span class="c14">Warehouse</span><span>&nbsp;application on your Force.com instance.</span></li><li class="c1 c4"><span>Click </span><span class="c5">Invoice Statements</span><span>, then click a specific record.</span></li><li class="c1 c4"><span>In the browser URL bar, select the record ID, which is everything after &ldquo;salesforce.com/&rdquo;. &nbsp;It should look something like &ldquo;a01E0000000diKc&rdquo;. &nbsp;Copy the ID.</span></li><li class="c1 c4"><span>Return to the browser or window tab showing your Heroku application at </span><span class="c16">https://</span><span class="c19 c16">{appname}</span><span class="c16">.herokuapp.com</span><span>.</span></li><li class="c1 c4"><span>Paste the ID into the field under Id.</span></li><li class="c1 c4"><span>Click </span><span class="c5">Create</span><span>.</span></li></ol><p class="c3 c8"><span></span></p><p class="c0"><img height="213" src="images/image00.png" width="340"></p><h3 class="c3"><a name="h.1pc502kg1ngv"></a><span>Tell Me More</span></h3><p class="c3"><span>Heroku&rsquo;s polyglot Platform as a Service design lets you easily deploy your applications with industry-standard tools, such as git. &nbsp;Normally, teams would be using a development environment like Eclipse, and in fact Heroku has released an Eclipse plugin for tighter integration with their platform. &nbsp;You can also interact with Heroku on the command line and directly get access to logs and performance tools for your applications.</span></p><h1 class="c3 c15"><a name="h.fwelbylxvrny"></a></h1><h1 class="c3"><a name="h.sh5hpbg4lqdp"></a><span>Part II: Create an Apex Trigger for Integration</span></h1><p class="c3"><span>Force.com can integrate with external systems using many different approaches. For example, without writing any code, you can declare workflow rules that send outbound email alerts and make simple Web service calls. To implement more complex scenarios, you might do it programmatically with Apex code.</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>This tutorial teaches you how create a Web service callout to integrate the Warehouse app with the fulfillment system you deployed in Part I. This fulfillment system, written in Java, is hosted on Heroku, but it could be any application with a Web service interface. </span></p><p class="c3 c8"><span></span></p><p class="c3"><span>The following screen illustrates the example scenario requirements: When an invoice statement&#39;s status changes to Closed in your Force.com system, the system should send a JSON-formatted message to the order fulfillment service running on Heroku, which in turn returns an order ID to the Force.com system that then records this in the Invoice. Time to get started.</span></p><p class="c3 c8"><span></span></p><p class="c0"><img height="198" src="images/image03.png" width="495"></p><h2 class="c3"><a name="h.fgax833a1ph"></a><span>Step 1: Create an External ID Field on Invoice Statement</span></h2><p class="c3"><span>To start, create a custom field in the Invoice Statement custom object that can store the order ID returned by the Java app running on Heroku. The field is an index into an external system, so it makes sense to make it an External ID.</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>If necessary, open a new browser tab and log in to Force.com.</span></li><li class="c1 c4"><span>Navigate to the </span><span class="c14">Invoice Statement </span><span>custom object by clicking </span><span class="c5">Your Name | Setup | Create | Objects | Invoice Statement</span><span>.</span></li><li class="c1 c4"><span>Scroll down to </span><span class="c14">Custom Fields &amp; Relationships</span><span>, and click </span><span class="c5">New</span><span>.</span></li><li class="c1 c4"><span>Select the </span><span class="c5">Text</span><span>&nbsp;field type and click </span><span class="c5">Next</span><span>.</span></li><li class="c1 c4"><span>Enter </span><span class="c16">OrderId</span><span>&nbsp;as the field label.</span></li><li class="c1 c4"><span>Enter </span><span class="c16">6</span><span>&nbsp;as the field length.</span></li><li class="c1 c4"><span>Leave the field name as the default: </span><span class="c16">OrderId</span><span>.</span></li><li class="c1 c4"><span>Click the </span><span class="c5">External ID </span><span>checkbox and click </span><span class="c5">Next</span><span>.</span></li><li class="c1 c4"><span>Click </span><span class="c5">Next</span><span>&nbsp;to accept the defaults.</span></li><li class="c1 c4"><span>Click </span><span class="c5">Save</span><span>.</span></li></ol><h2 class="c3"><a name="h.217nub6esq17"></a><span>Step 2: Create a Remote Site Record</span></h2><p class="c3"><span>The Force.com platform implements very conservative security controls. By default, Force.com prohibits callouts to external sites. Therefore, this lesson teaches you how to register the Heroku Java site in the Remote Site Settings page.</span></p><p class="c3 c8"><span></span></p><p class="c3"><span class="c5">Note: </span><span>Just for fun, you can skip this section and create and test the callout in steps 3 and 4 below to observe the error message that is generated when an app attempts to callout to a URL without permission. Don&#39;t forget to come back and add the remote site record, though!</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Click </span><span class="c5">Your Name | Setup | Security Controls | Remote Site Settings | New Remote Site </span><span>and then fill in the site settings:</span></li></ol><ol class="c33" start="1"><li class="c3 c17 c4"><span>In the </span><span class="c14">Remote Site Name </span><span>field, enter </span><span class="c16">FulfillmentWebService</span><span>. &nbsp;(no spaces)</span></li><li class="c3 c17 c4"><span>In the </span><span class="c14">Remote Site URL </span><span>field, enter (exactly) </span><span class="c16">https://</span><span class="c16 c19">{appname}</span><span class="c16">.herokuapp.com</span></li><li class="c3 c17 c4"><span>Leave all other default values.</span></li></ol><ol class="c12" start="2"><li class="c1 c4"><span>Click </span><span class="c5">Save</span><span>.</span></li></ol><p class="c3 c8"><span></span></p><p class="c3"><span>Now, any Apex code in your app can call the fulfillment Web service.</span></p><h2 class="c3"><a name="h.nfc20t8ry5j4"></a><span>Step 3: Create an Integration Apex </span><span>Class</span><sup></sup></h2><p class="c3"><span>Now that your app can access an external URL, it&#39;s time to implement the callout. Force.com doesn&rsquo;t allow Apex triggers to make synchronous web service calls directly -- this restriction on trigger logic makes sense: without it, a long-running Web service might hold a record lock and reduce concurrency for your app. </span></p><p class="c3 c8"><span></span></p><p class="c3"><span>This steps in this tutorial teach you how to build out the correct approach, which is to create an Apex class with an asynchronous method that uses the @future annotation, and then build a trigger to call the method as necessary. When the trigger calls the asynchronous method, Force.com queues the call, execution of the trigger completes, and releases any record locks. Eventually, when the method call reaches the top of the queue, Force.com executes the method and posts the invoice to the order fulfillment Web service running on Heroku.</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>To create the Integration class with the postOrder method:</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Click </span><span class="c5">Your Name | Setup | Develop | Apex Classes</span><span>.</span></li><li class="c1 c4"><span>Click </span><span class="c5">New</span><span>&nbsp;and paste in the following code:</span></li></ol><p class="c3"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c3"><span class="c9">public class Integration {</span></p><p class="c3 c8"><span class="c9"></span></p><p class="c3"><span class="c9">&nbsp; // The ExternalOrder class holds a string and integer</span></p><p class="c3"><span class="c9">&nbsp; // received from the external fulfillment system.</span></p><p class="c3 c8"><span class="c9"></span></p><p class="c3"><span class="c9">&nbsp; public class ExternalOrder {</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; public String id {get; set;}</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; public Integer order_number {get; set;}</span></p><p class="c3"><span class="c9">&nbsp; }</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; </span></p><p class="c3"><span class="c9">&nbsp; // The postOrder method integrates the local Force.com invoicing system </span></p><p class="c3"><span class="c9">&nbsp; // with a remote fulfillment system; specifically, by posting data about </span></p><p class="c3"><span class="c9">&nbsp; // closed orders to the remote system. Functionally, the method 1) prepares </span></p><p class="c3"><span class="c9">&nbsp; // JSON-formatted data to send to the remote service, 2) makes an HTTP call </span></p><p class="c3"><span class="c9">&nbsp; // to send the prepared data to the remote service, and then 3) processes </span></p><p class="c3"><span class="c9">&nbsp; // any JSON-formatted data returned by the remote service to update the </span></p><p class="c3"><span class="c9">&nbsp; // local Invoices with the corresponding external Ids in the remote system.</span></p><p class="c3"><span class="c9">&nbsp; </span></p><p class="c3"><span class="c9">&nbsp; @future (callout=true) // indicates that this is an asynchronous call</span></p><p class="c3"><span class="c9">&nbsp; public static void postOrder(List&lt;Id&gt; invoiceIds) {</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // 1) see above</span></p><p class="c3 c8"><span class="c9"></span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // Create a JSON generator object</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; JSONGenerator gen = JSON.createGenerator(true);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // open the JSON generator</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; gen.writeStartArray();</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // interate through the list of invoices passed in to the call</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // writing each invoice Id to the array</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; for (Id invoiceId : invoiceIds) {</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; gen.writeStartObject();</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; gen.writeStringField(&#39;id&#39;, invoiceId);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; gen.writeEndObject(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; }</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // close the JSON generator</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; gen.writeEndArray();</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // create a string from the JSON generator</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; String jsonOrders = gen.getAsString();</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // debugging call, which you can check in console logs</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; System.debug(&#39;jsonOrders: &#39; + jsonOrders);</span></p><p class="c3 c8"><span class="c9"></span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // 2) see above </span></p><p class="c3 c8"><span class="c9"></span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // create an HTTPrequest object &nbsp; &nbsp;</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; HttpRequest req = new HttpRequest(); </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // set up the HTTP request with a method, endpoint, header, and body</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; req.setMethod(&#39;POST&#39;);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // DON&#39;T FORGET TO UPDATE THE FOLLOWING LINE WITH YOUR appid</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; req.setEndpoint(&#39;https://</span><span class="c9 c19">{appname}</span><span class="c9">.herokuapp.com/order&#39;);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; req.setHeader(&#39;Content-Type&#39;, &#39;application/json&#39;);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; req.setBody(jsonOrders); &nbsp; &nbsp;</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // create a new HTTP object</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; Http http = new Http();</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // create a new HTTP response for receiving the remote response</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // then use it to send the configured HTTPrequest</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; HTTPResponse res = http.send(req);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // debugging call, which you can check in console logs</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; System.debug(&#39;Fulfillment service returned &#39;+ res.getBody());</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // 3) see above</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // Examine the status code from the HTTPResponse</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // If status code != 200, write debugging information, done</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; if (res.getStatusCode() != 200) {</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; System.debug(&#39;Error from &#39; + req.getEndpoint() + &#39; : &#39; + </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; &nbsp; res.getStatusCode() + &#39; &#39; + res.getStatus());</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; }</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // If status code = 200, update each Invoice Statement</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; // with the external ID returned by the fulfillment service.</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; else {</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; // Retrieve all of the Invoice Statement sObjects </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; // originally passed into the method call to prep for update. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; List&lt;Invoice_Statement__c&gt; invoices = </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; &nbsp; [SELECT Id FROM Invoice_Statement__c WHERE Id IN :invoiceIds];</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; // Create a list of external orders by deserializing the</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; // JSON data returned by the fulfillment service.</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; List&lt;ExternalOrder&gt; orders = </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; &nbsp; (List&lt;ExternalOrder&gt;)JSON.deserialize(res.getBody(), </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List&lt;ExternalOrder&gt;.class);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; // Create a map of Invoice Statement Ids from the retrieved</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; // invoices list.</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; Map&lt;Id, Invoice_Statement__c&gt; invoiceMap = </span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; &nbsp; new Map&lt;Id, Invoice_Statement__c&gt;(invoices);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; // Update the order numbers in the invoices</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; for ( ExternalOrder order : orders ) {</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; &nbsp; Invoice_Statement__c invoice = invoiceMap.get(order.id);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; &nbsp; invoice.OrderId__c = String.valueOf(order.order_number);</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; }</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; // Update all invoices in the database with a bulk update</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; &nbsp; update invoices;</span></p><p class="c3"><span class="c9">&nbsp; &nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;</span></p><p class="c3"><span class="c9">&nbsp; }</span></p><p class="c3"><span class="c9">}</span></p><p class="c3 c8"><span class="c9"></span></p><p class="c1"><span>Don&rsquo;t miss replacing the </span><span class="c14 c19">{appname}</span><span>&nbsp;with yours.</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="3"><li class="c1 c4"><span>Click </span><span class="c5">Save</span><span>.</span></li></ol><p class="c3 c8"><span></span></p><p class="c3"><span>See the embedded comments for more information about the code example.</span></p><p class="c3 c8"><span></span></p><p class="c3"><span class="c5">Note: </span><span>This class method demonstrates an important best practice to always consider when developing with Force.com: bulk processing.</span></p><h2 class="c3"><a name="h.ovy1gmh3ohxe"></a><span>Step 4: Test the @future Method</span></h2><p class="c3"><span>Before creating a trigger that calls an @future method, it&rsquo;s best practice to interactively test the method by itself and validate that the remote site configuration. To test the method interactively, you can use the Developer Console.</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Click </span><span class="c5">Your Name | Developer Console</span><span>.</span></li><li class="c1 c4"><span>Click the box marked </span><span class="c5">Click here to enter Apex Code </span><span>and enter the following code:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1"><span class="c9">// Get an Invoice_Statement__c for testing</span></p><p class="c1"><span class="c9">Invoice_Statement__c invoice = [SELECT ID FROM Invoice_Statement__c LIMIT 1];</span></p><p class="c1"><span class="c9">// Call the postOrder method to test the asynchronous call</span></p><p class="c1"><span class="c9">Integration.postOrder(new List&lt;Id&gt;{invoice.id});</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="3"><li class="c1 c4"><span>Click the </span><span class="c5">Open Log </span><span>checkbox.</span></li><li class="c1 c4"><span>Click the </span><span class="c5">Execute</span><span>&nbsp;button. You should see two entries in the logs.</span></li><li class="c1 c4"><span>Double-click the second line. It should have </span><span class="c14">Future Handler </span><span>as its operation and a status of </span><span class="c14">Success</span><span>.</span></li><li class="c1 c4"><span>Click the </span><span class="c5">Filter</span><span>&nbsp;checkbox under the </span><span class="c14">Execution Log </span><span>and type </span><span class="c16">DEBUG</span><span>&nbsp;as the filter text. Scroll down and double-click the last line of the execution log. You should see a popup with the response from the fulfillment Web service. For example:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1"><span class="c9">08:08:42:962 USER_DEBUG [58]|DEBUG|Fulfillment service returned [{&quot;order_number&quot;:2,&quot;id&quot;:&quot;a01E0000009RpppIAC&quot;}]</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>Now that you have a functional @future method that can call the fulfillment Web service, it&#39;s time to tie things together with a trigger.</span></p><p class="c3"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><h2 class="c3"><a name="h.2nu3ffz5r16o"></a><span>Step 5: Create a Trigger to Call the @future Method</span></h2><p class="c3"><span>To create a trigger on the Invoice Statement object that calls the </span><span class="c14">Integration.postOrder </span><span>method, complete the following steps:</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Click &nbsp;</span><span class="c5">Your Name | Setup | Create | Objects | Invoice Statement</span><span>.</span></li><li class="c1 c4"><span>Scroll down to </span><span class="c14">Triggers</span><span>, click </span><span class="c5">New</span><span>&nbsp;and replace the trigger skeleton with the following code:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1"><span class="c9">trigger HandleOrderUpdate on Invoice_Statement__c (after update) {</span></p><p class="c1"><span class="c9">&nbsp; </span></p><p class="c1"><span class="c9">&nbsp; // Create a map of IDs to all of the *old* versions of sObjects</span></p><p class="c1"><span class="c9">&nbsp; // updated by the call that fires the trigger.</span></p><p class="c1"><span class="c9">&nbsp; &nbsp; Map&lt;ID, Invoice_Statement__c&gt; oldMap =</span></p><p class="c1"><span class="c9">&nbsp; &nbsp; new Map&lt;ID, Invoice_Statement__c&gt;(Trigger.old);</span></p><p class="c1 c8"><span class="c9"></span></p><p class="c1"><span class="c9">&nbsp; // Create an empty list of Ids</span></p><p class="c1"><span class="c9">&nbsp; List&lt;Id&gt; invoiceIds = new List&lt;Id&gt;();</span></p><p class="c1 c8"><span class="c9"></span></p><p class="c1"><span class="c9">&nbsp; // Interate through all of the *new* versions of Invoice_Statement </span></p><p class="c1"><span class="c9">&nbsp; // sObjects updated by the call that fires the trigger, adding </span></p><p class="c1"><span class="c9">&nbsp; // corresponding Ids to the invoiceIds List, but *only* when an</span></p><p class="c1"><span class="c9">&nbsp; // sObject&#39;s status changed from a non-&quot;Closed&quot; value to &quot;Closed&quot;.</span></p><p class="c1"><span class="c9">&nbsp; for (Invoice_Statement__c invoice: Trigger.new) {</span></p><p class="c1"><span class="c9">&nbsp; &nbsp; if (invoice.status__c == &#39;Closed&#39; &amp;&amp;</span></p><p class="c1"><span class="c9">&nbsp; &nbsp; &nbsp; oldMap.get(invoice.Id).status__c != &#39;Closed&#39;) {</span></p><p class="c1"><span class="c9">&nbsp; &nbsp; &nbsp; &nbsp; invoiceIds.add(invoice.Id);</span></p><p class="c1"><span class="c9">&nbsp; &nbsp; &nbsp; }</span></p><p class="c1"><span class="c9">&nbsp; &nbsp; }</span></p><p class="c1 c8"><span class="c9"></span></p><p class="c1"><span class="c9">&nbsp; // If the list of Ids is not empty, call Integration.postOrder,</span></p><p class="c1"><span class="c9">&nbsp; // supplying the list of Ids for fulfillment.</span></p><p class="c1"><span class="c9">&nbsp; if (invoiceIds.size() &gt; 0) {</span></p><p class="c1"><span class="c9">&nbsp; &nbsp; Integration.postOrder(invoiceIds);</span></p><p class="c1"><span class="c9">&nbsp; }</span></p><p class="c1"><span class="c9">}</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="3"><li class="c1 c4"><span>Click </span><span class="c5">Save</span><span>.</span></li></ol><p class="c3 c8"><span></span></p><p class="c3"><span>The comments in the code explain what is happening. In particular, understand that Force.com triggers must be able to handle both single row and bulk updates because of the varying types of calls that can fire them (single row or bulk update calls). The trigger creates a list of IDs of invoices that have been closed in this update, and then calls the @future method once, passing the list of IDs.</span></p><h2 class="c3"><a name="h.we1pdt4ibhiq"></a><span>Step 6: Test the Integration</span></h2><p class="c3"><span>With the trigger in place, test the integration by firing the trigger.</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Select the </span><span class="c5">Warehouse</span><span>&nbsp;app.</span></li><li class="c1 c4"><span>Click the </span><span class="c5">Invoice Statements </span><span>tab.</span></li><li class="c1 c4"><span>Click into one of the recent invoices and notice that there is no OrderId for the invoice.</span></li><li class="c1 c4"><span>If the </span><span class="c14">Status</span><span>&nbsp;is already </span><span class="c14">Closed</span><span>, double-click the word </span><span class="c5">Closed</span><span>, change it to </span><span class="c5">Open</span><span>&nbsp;and click </span><span class="c5">Save</span><span>.</span></li><li class="c1 c4"><span>Double-click the </span><span class="c5">Status</span><span>&nbsp;value, change it to </span><span class="c5">Closed</span><span>&nbsp;and click </span><span class="c5">Save</span><span>. This action triggers the asynchronous callout.</span></li><li class="c1 c4"><span>Wait a few seconds and refresh the page in the browser.</span></li><li class="c1 c4"><span>You should see an external order ID appear in the OrderId field.</span></li></ol><p class="c3 c8"><span></span></p><p class="c3"><span>Before:</span></p><p class="c3 c8"><span></span></p><p class="c0"><img height="397" src="images/image08.png" width="588"></p><p class="c3"><span>After:</span></p><p class="c0 c8"><span></span></p><p class="c0"><img height="399" src="images/image01.png" width="593"></p><p class="c3 c8"><span></span></p><h2 class="c3"><a name="h.fv6gbohj21dj"></a><span>Summary</span></h2><p class="c3"><span>Congratulations! Your app is sending invoices for fulfillment. You have successfully created an asynchronous Apex class that posted invoice details to another app hosted elsewhere, in this case on Heroku. Of course, your external application could reside anywhere as long as you can access it with a Web services call. Your class uses open standards technology, including JSON and REST to transmit data, and a trigger on Invoice Statements to execute the process. </span></p><h1 class="c3 c15"><a name="h.eacxpnnjawqj"></a></h1><h1 class="c3 c15"><a name="h.akyfr8ea151c"></a></h1><hr style="page-break-before:always;display:none;"><h1 class="c3 c15"><a name="h.dk1y4yy8kmv"></a></h1><h1 class="c3"><a name="h.5l9vqdmv432v"></a><span>Part III: Update the Heroku App</span></h1><p class="c3"><span>You now have two sides of an integration in place: one running a Java endpoint on Heroku, and another in Force.com that communicates with the endpoint when the appropriate changes take place. &nbsp;Now that you&rsquo;ve got the connection in place, update the Heroku application to retrieve the pertinent information it is dealing with and display it to the user.</span></p><h2 class="c3"><a name="h.to17tripf0ho"></a><span>Step 1: Configure Remote Access </span></h2><p class="c3"><span>Before an application can use OAuth 2.0 with Force.com, you have to configure your environment. Log in to your Force.com organization as an administrator and configure a remote access application:</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Navigate to </span><span class="c5">Your Name | (App Setup) | Develop | Remote Access</span><span>.</span></li><li class="c1 c4"><span>Click </span><span class="c5">New</span><span>.</span></li><li class="c1 c4"><span>In the </span><span class="c14">Application</span><span>&nbsp;field, enter </span><span class="c16">Buyer Client</span></li><li class="c1 c4"><span>In the </span><span class="c14">Callback URL </span><span>field, enter the following (replacing </span><span class="c14">{appname}</span><span>&nbsp;with yours)</span><span>:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1"><span class="c9">https://</span><span class="c9 c19">{appname}</span><span class="c9">.herokuapp.com/_auth</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="5"><li class="c1 c4"><span>In the </span><span class="c14">Email</span><span>&nbsp;field, enter your email address.</span></li><li class="c1 c4"><span>Click </span><span class="c5">Save</span><span>.</span></li></ol><p class="c3 c8"><span></span></p><p class="c3"><span>The resulting page should look similar to this:</span></p><p class="c0"><img height="349" src="images/image06.png" width="586"></p><h2 class="c3"><a name="h.8vw1axvleqnl"></a><span>Step 2: Update your application with a new branch</span></h2><p class="c3"><span>While you were creating a new Apex trigger on your Force.com instance, developers have added new functionality to the original project and placed into a specific branch on github. &nbsp;Git allows for easy branching and merging of code for your projects. &nbsp;Using this branch, you will be able to test out the new features - specifically the ability for your Heroku application to access your Force.com records directly. &nbsp;It&rsquo;s easy to add this branch, called </span><span class="c14">full</span><span>&nbsp;on the main project, to your codebase:</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Return to the command line, and make sure you are in the </span><span class="c14">spring-mvc-fulfillment-base</span><span>&nbsp;folder.</span></li></ol><ol class="c12" start="2"><li class="c1 c4"><span>Enter Execute the following command to fetch the full branch and merge it with your master branch, all in one step: </span></li></ol><p class="c3 c8"><span></span></p><p class="c1 c10"><span class="c16">git pull origin full</span></p><p class="c1 c2"><span class="c16"></span></p><ol class="c12" start="3"><li class="c1 c4"><span>You need to set your Remote Access keys to your Heroku application. &nbsp;Enter:</span></li></ol><p class="c1 c8"><span class="c24 c21 c30"></span></p><p class="c1"><span class="c24 c30 c21">heroku config:add OAUTH_CLIENT_KEY=</span><span class="c24 c19 c21">PUBLICKEY</span><span class="c24 c30 c21">&nbsp;OAUTH_CLIENT_SECRET=</span><span class="c19 c21 c24">PRIVATEKEY</span></p><p class="c3 c8"><span></span></p><p class="c1"><span>Replacing PUBLICKEY with the Consumer Key from your Remote Access record, and &nbsp;PRIVATEKEY with the Consumer Secret. &nbsp;It may be helpful to do this in a text editor before putting it on the command line.</span></p><p class="c3"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><ol class="c12" start="4"><li class="c1 c4"><span>Execute the following command to push the local updates to Heroku:</span></li></ol><p class="c1 c10"><span>&nbsp;</span></p><p class="c1 c10"><span class="c16">git push heroku master</span></p><p class="c3 c8"><span class="c16"></span></p><p class="c1 c8"><span></span></p><p class="c3"><span>Once the new version of the app is up, refresh your browser to see it. The biggest difference is the addition of an OAuth flow. This logic lets the application get a user&rsquo;s permission to have session information without requiring the third-party server to handle the user&rsquo;s credentials. With this added to the project, the fulfillment application can use the Force.com REST API to access information directly from the user&rsquo;s instance.</span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p><h3 class="c3"><a name="h.qb3nvg7rf7bf"></a><span class="c25">Tell Me More</span></h3><p class="c3"><span>You can review all of the changes brought in by this branch on github:</span></p><p class="c3"><span class="c7"><a class="c11" href="https://github.com/developerforce/spring-mvc-fulfillment-base/compare/master...full">https://github.com/developerforce/spring-mvc-fulfillment-base/compare/master...full</a></span></p><p class="c3 c8"><span></span></p><p class="c3"><span>If you inspect the changes in the new </span><span>files</span><sup></sup><span>, you will notice that they use the Force.com REST API to manipulate </span><span class="c14">Invoice Statement </span><span>records in Force.com. Look at </span><span class="c14">InvoiceServiceImpl.java </span><span>in particular to see how it creates, queries, retrieves and deletes invoices. This tutorial only uses the </span><span class="c14">findOrder() </span><span>method; the others are included for your reference.</span></p><h2 class="c3 c23"><a name="h.eqzcgbl4izzv"></a></h2><h2 class="c3"><a name="h.3oi3yr4rzvau"></a><span>Step 3: Update the User Interface with Invoice Information</span></h2><p class="c3"><span>You have added brand new functionality by merging a branch into your local code, but there&rsquo;s a feature still missing - the application now understands how to use OAuth and how access data from the Force.com platfrom, but the web page hasn&rsquo;t been updated to display the Invoice Statement fields.</span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p><ol class="c12" start="1"><li class="c1 c4"><span>Open </span><span class="c5">src/main/webapp/WEB-INF/views/order.jsp</span><span>&nbsp;in the text or code editor of your choice.</span></li></ol><ol class="c12" start="2"><li class="c1 c4"><span>Just before the following line:</span></li></ol><p class="c3 c8"><span></span></p><p class="c1"><span class="c9">&lt;a href=&quot;javascript:history.back()&quot;&gt;Back&lt;/a&gt; &lt;input id=&quot;delete&quot; type=&quot;submit&quot; value=&quot;Delete&quot; /&gt;</span></p><p class="c3 c8"><span></span></p><p class="c1"><span>add:</span></p><p class="c3 c8"><span></span></p><p class="c1"><span class="c9">&lt;h3&gt;Invoice&lt;/h3&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c1"><span class="c9">&lt;p&gt;Number: &lt;c:out value=&quot;${invoice.number}&quot;/&gt;&lt;/p&gt;</span></p><p class="c1"><span class="c9">&lt;p&gt;Description: &lt;c:out value=&quot;${invoice.description}&quot;/&gt;&lt;/p&gt;</span></p><p class="c1"><span class="c9">&lt;p&gt;Status: &lt;c:out value=&quot;${invoice.status}&quot;/&gt;&lt;/p&gt;</span></p><p class="c3 c8"><span></span></p><ol class="c12" start="3"><li class="c1 c4"><span class="c5">Save</span><span>&nbsp;the file.</span></li></ol><ol class="c12" start="4"><li class="c1 c4"><span>Return to the command line, and make sure you are in the </span><span class="c14">spring-mvc-fulfillment-base</span><span>&nbsp;folder.</span></li><li class="c1 c4"><span>Execute: </span></li></ol><p class="c1 c10"><span class="c16">git commit -am &quot;Updating UI&rdquo;</span></p><ol class="c12" start="6"><li class="c1 c4"><span>Execute:</span></li></ol><p class="c1 c10"><span>&nbsp;</span><span class="c16">git push heroku master</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>Once the new version of the app is deployed, refresh your browser to see it. Notice that, given an Id, this code retrieves the corresponding invoice record. Because there might be mock Id&#39;s in the database that are not in Force.com, the app handles the corresponding exception by showing default data. Adding the invoice to the model makes it available to the view below.</span></p><p class="c3 c8"><span></span></p><p class="c3"><span>Now when you test the fulfillment application, it will show the invoice information currently in your Force.com instance by grabbing the information via the REST API using the record ID:</span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p><p class="c0"><img height="185" src="images/image05.png" width="330"></p><p class="c3 c8"><span></span></p><h3 class="c3"><a name="h.myu92mt386mc"></a><span>Tell Me More</span></h3><p class="c3"><span>To really see the application in motion, you can edit information on Force.com (like the Description of the Invoice Statement) and see it represented the next time you load that order on Heroku.</span></p><p class="c3 c8"><span class="c5"></span></p><p class="c3 c8"><span class="c5"></span></p><p class="c3"><span>N</span><span>otice that the web service call from Force.com to create orders is not secured. Securing this call goes beyond the scope of this workbook, but a simple solution would be to set up a shared secret between the Force.com app and the fulfillment app. The Force.com app would create an HMAC of the parameters in the request, using the secret, and the fulfillment app would verify the HMAC.</span></p><h2 class="c3"><a name="h.6sk8zyazmu6h"></a><span>Summary</span></h2><p class="c3"><span>With a combination of OAuth authentication, the REST API, Apex Triggers, future callouts and the polyglot framework of the Heroku platform, you have created and deployed a bi-directional integration between two clouds.</span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p><p class="c3 c8"><span></span></p></div></body></html>